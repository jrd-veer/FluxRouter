---
name: FluxRouter Pipeline

"on":
  workflow_dispatch:
  push:
    branches: [main, dev, 'feature/*']
  pull_request:
    branches: [main]

env:
  COMPOSE_PROJECT_NAME: fluxrouter-ci

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install flake8 yamllint
          # Install hadolint for Dockerfile linting
          wget -O hadolint \
            https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/

      - name: Lint Python code
        run: |
          flake8 backend/app.py --max-line-length=100 --ignore=E501,W503

      - name: Lint YAML files
        run: |
          yamllint -d "{extends: default, rules: {line-length: disable, trailing-spaces: disable}}" docker-compose.yml .github/workflows/ci.yml

      - name: Lint Dockerfiles
        run: |
          hadolint proxy/Dockerfile
          hadolint web/Dockerfile
          hadolint backend/Dockerfile

      - name: Validate Docker Compose
        run: |
          docker compose -p fluxrouter config

  build:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create environment file with secure secret
        run: |
          cp env.example .env
          echo "SECRET_KEY=$(openssl rand -hex 32)" >> .env

      - name: Build Docker images
        run: |
          docker compose -p fluxrouter build

      - name: Tag Docker images
        run: |
          # Extract commit SHA and branch/tag info
          COMMIT_SHA=$(echo $GITHUB_SHA | cut -c1-8)
          BRANCH_NAME=$(echo $GITHUB_REF | sed 's/refs\/heads\///' | sed 's/refs\/tags\///' | sed 's/refs\/pull\//pr-/' | sed 's/\/merge//')
          
          # Clean branch name for valid Docker tags (replace special chars with hyphens)
          CLEAN_BRANCH=$(echo $BRANCH_NAME | sed 's/[^a-zA-Z0-9._-]/-/g' | tr '[:upper:]' '[:lower:]')
          
          echo "Branch: $BRANCH_NAME"
          echo "Clean branch: $CLEAN_BRANCH"
          echo "Commit SHA: $COMMIT_SHA"
          
          # Always tag with commit SHA
          docker tag fluxrouter-proxy:latest fluxrouter-proxy:$COMMIT_SHA
          docker tag fluxrouter-web:latest fluxrouter-web:$COMMIT_SHA
          docker tag fluxrouter-backend:latest fluxrouter-backend:$COMMIT_SHA
          
          # Tag with branch-specific tags
          if [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
            # Main branch gets 'latest' and 'stable' tags
            docker tag fluxrouter-proxy:latest fluxrouter-proxy:stable
            docker tag fluxrouter-web:latest fluxrouter-web:stable
            docker tag fluxrouter-backend:latest fluxrouter-backend:stable
            echo "Tagged as: latest, stable, $COMMIT_SHA"
          elif [[ "$GITHUB_REF" == "refs/heads/dev" ]]; then
            # Dev branch gets 'dev' and 'dev-<sha>' tags
            docker tag fluxrouter-proxy:latest fluxrouter-proxy:dev
            docker tag fluxrouter-web:latest fluxrouter-web:dev
            docker tag fluxrouter-backend:latest fluxrouter-backend:dev
            docker tag fluxrouter-proxy:latest fluxrouter-proxy:dev-$COMMIT_SHA
            docker tag fluxrouter-web:latest fluxrouter-web:dev-$COMMIT_SHA
            docker tag fluxrouter-backend:latest fluxrouter-backend:dev-$COMMIT_SHA
            echo "Tagged as: dev, dev-$COMMIT_SHA, $COMMIT_SHA"
          else
            # Feature branches and PRs get branch-specific tags
            docker tag fluxrouter-proxy:latest fluxrouter-proxy:$CLEAN_BRANCH-$COMMIT_SHA
            docker tag fluxrouter-web:latest fluxrouter-web:$CLEAN_BRANCH-$COMMIT_SHA
            docker tag fluxrouter-backend:latest fluxrouter-backend:$CLEAN_BRANCH-$COMMIT_SHA
            echo "Tagged as: $CLEAN_BRANCH-$COMMIT_SHA, $COMMIT_SHA"
          fi

      - name: Start services with scaling
        run: |
          docker compose -p fluxrouter up --scale backend=2 -d

      - name: Verify Docker Network Configuration
        run: |
          echo "Verifying that the backend network is isolated..."
          docker network inspect fluxrouter-backend | grep '"Internal": true'
          if [ $? -ne 0 ]; then
            echo "::error::Network 'fluxrouter-backend' is not set to internal: true!"
            docker network inspect fluxrouter-backend
            exit 1
          fi
          echo "✅ Backend network is correctly configured as internal."

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 30

          # Check container status
          docker compose -p fluxrouter ps

          # Check container logs for debugging
          echo "=== Initial Backend Logs ==="
          docker compose -p fluxrouter logs backend | tail -10
          echo "=== Initial Proxy Logs ==="
          docker compose -p fluxrouter logs proxy | tail -10
          echo "=== Initial Web Logs ==="
          docker compose -p fluxrouter logs web | tail -10

          # Wait for all services to be healthy using docker compose ps
          echo "Waiting for all services to be healthy..."
          timeout 120 bash -c '
            while true; do
              # Count healthy containers
              HEALTHY_COUNT=$(docker compose -p fluxrouter ps --format "{{.Name}}:{{.Status}}" | grep -c "(healthy)")
              TOTAL_COUNT=$(docker compose -p fluxrouter ps --format "{{.Name}}" | wc -l)
              
              echo "Healthy containers: $HEALTHY_COUNT/$TOTAL_COUNT"
              
              # Check if all containers are healthy
              if [ "$HEALTHY_COUNT" -eq "$TOTAL_COUNT" ]; then
                break
              fi
              
              # Show current status
              docker compose -p fluxrouter ps
              sleep 5
            done
          '
          echo "✅ All services are healthy"

      - name: Debug Container Names
        run: |
          echo "🔍 Debugging container names for test compatibility..."
          echo "=== All running containers ==="
          docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
          echo
          echo "=== Docker Compose containers ==="
          docker compose -p fluxrouter ps --format "table {{.Name}}\t{{.Service}}\t{{.Status}}"
          echo
          echo "=== Backend containers specifically ==="
          docker ps --format '{{.Names}}' | grep backend || echo "No containers with 'backend' in name"
          docker compose -p fluxrouter ps --format '{{.Name}}' | grep backend || echo "No compose services with 'backend'"
          echo
          echo "=== Container name patterns ==="
          echo "Containers matching 'fluxrouter-backend-[0-9]+' pattern:"
          docker ps --format '{{.Names}}' | grep -E 'fluxrouter-backend-[0-9]+' || echo "None found"
          echo "Containers matching 'backend-[0-9]+' pattern:"
          docker ps --format '{{.Names}}' | grep -E 'backend-[0-9]+' || echo "None found"

      - name: Run Phase 1 Verification Tests
        run: |
          echo "🧪 Running Phase 1 verification tests..."
          cd tests
          chmod +x phase1-verify.sh phase2-verify.sh test-lib.sh
          CI_MODE=true ./phase1-verify.sh

      - name: Run Phase 2 Verification Tests
        run: |
          echo "🧪 Running Phase 2 verification tests..."
          cd tests
          CI_MODE=true ./phase2-verify.sh

      - name: Run Phase 3 Extended Tests
        run: |
          echo "🧪 Running Phase 3 extended tests..."
          cd tests
          CI_MODE=true ./phase3-extended-tests.sh

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Proxy Logs ==="
          docker compose -p fluxrouter logs proxy
          echo "=== Web Logs ==="
          docker compose -p fluxrouter logs web
          echo "=== Backend Logs ==="
          docker compose -p fluxrouter logs backend

      - name: Cleanup
        if: always()
        run: |
          docker compose -p fluxrouter down -v
          docker system prune -f

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create environment file with secure secret
        run: |
          cp env.example .env
          echo "SECRET_KEY=$(openssl rand -hex 32)" >> .env

      - name: Build production images
        run: |
          docker compose -p fluxrouter build

      - name: Deploy with zero downtime
        run: |
          echo "🚀 Deploying FluxRouter to production..."
          # Stop old containers gracefully
          docker compose -p fluxrouter down --timeout 30 || true
          # Start new containers with scaling
          docker compose -p fluxrouter up --scale backend=2 -d
          # Wait for services to be healthy
          echo "⏳ Waiting for services to be healthy..."
          timeout 120 bash -c '
            while true; do
              # Count healthy containers
              HEALTHY_COUNT=$(docker compose -p fluxrouter ps --format "{{.Name}}:{{.Status}}" | grep -c "(healthy)")
              TOTAL_COUNT=$(docker compose -p fluxrouter ps --format "{{.Name}}" | wc -l)
              
              echo "Healthy containers: $HEALTHY_COUNT/$TOTAL_COUNT"
              
              # Check if all containers are healthy
              if [ "$HEALTHY_COUNT" -eq "$TOTAL_COUNT" ]; then
                break
              fi
              
              # Show current status
              docker compose -p fluxrouter ps
              sleep 5
            done
          '
          # Verify deployment
          if curl -k -s https://localhost/api/health | jq -e '.status == "ok"' > /dev/null; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed - rolling back..."
            docker compose -p fluxrouter down
            exit 1
          fi

      - name: Post-deployment verification
        run: |
          echo "🔍 Running post-deployment verification..."
          # Check all services are healthy
          docker compose -p fluxrouter ps
          # Test key endpoints
          curl -k -s https://localhost/ > /dev/null
          curl -k -s https://localhost/api/health > /dev/null
          curl -k -s https://localhost/api/info > /dev/null
          echo "✅ Post-deployment verification complete"

      - name: Cleanup old images
        run: |
          docker system prune -f --filter "until=24h"
